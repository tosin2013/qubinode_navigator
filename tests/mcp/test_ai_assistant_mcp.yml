---
- name: Test AI Assistant MCP Server
  hosts: localhost
  gather_facts: false
  vars:
    ai_mcp_port: 8081
    ai_api_key: "{{ lookup('env', 'MCP_API_KEY') | default('74008c5dde3fca81946c7a5c019ee1e64aef85dbe7a08c2ea9a709bdcfae1e0f') }}"

  tasks:
    - name: Discover AI Assistant MCP Server Capabilities
      tosin2013.mcp_audit.mcp_server_info:
        transport: sse
        server_url: "http://localhost:{{ ai_mcp_port }}/sse"
        server_headers:
          X-API-Key: "{{ ai_api_key }}"
        timeout: 30
      register: ai_server_info
      tags: [discovery]

    - name: Display AI Assistant Capabilities
      ansible.builtin.debug:
        msg: |
          Server: {{ ai_server_info.server_info.server_name }}
          Protocol: {{ ai_server_info.server_info.protocol_version }}
          Tools: {{ ai_server_info.server_info.available_tools | join(', ') }}
      tags: [discovery]

    - name: Test query_documents Tool
      tosin2013.mcp_audit.mcp_test_tool:
        transport: sse
        server_url: "http://localhost:{{ ai_mcp_port }}/sse"
        server_headers:
          X-API-Key: "{{ ai_api_key }}"
        tool_name: query_documents
        tool_arguments:
          query: "How do I deploy a VM?"
          max_results: 3
        timeout: 45
      register: query_test
      tags: [tools, query_documents]

    - name: Verify query_documents Response
      ansible.builtin.assert:
        that:
          - query_test.success
          - query_test.test_passed
          - query_test.tool_result.content is defined
        fail_msg: "query_documents test failed"
      tags: [tools, query_documents]

    - name: Test chat_with_context Tool
      tosin2013.mcp_audit.mcp_test_tool:
        transport: sse
        server_url: "http://localhost:{{ ai_mcp_port }}/sse"
        server_headers:
          X-API-Key: "{{ ai_api_key }}"
        tool_name: chat_with_context
        tool_arguments:
          message: "What is Qubinode Navigator?"
          context:
            source: "automated_test"
        timeout: 90
      register: chat_test
      tags: [tools, chat]

    - name: Verify chat_with_context Response
      ansible.builtin.assert:
        that:
          - chat_test.success
          - chat_test.test_passed
        fail_msg: "chat_with_context test failed"
      tags: [tools, chat]

    - name: Test get_project_status Tool
      tosin2013.mcp_audit.mcp_test_tool:
        transport: sse
        server_url: "http://localhost:{{ ai_mcp_port }}/sse"
        server_headers:
          X-API-Key: "{{ ai_api_key }}"
        tool_name: get_project_status
        tool_arguments: {}
        timeout: 15
      register: status_test
      tags: [tools, status]

    - name: Verify get_project_status Response
      ansible.builtin.assert:
        that:
          - status_test.success
          - status_test.test_passed
        fail_msg: "get_project_status test failed"
      tags: [tools, status]

    - name: Generate AI Assistant Test Report
      ansible.builtin.copy:
        content: |
          # AI Assistant MCP Server Test Report

          **Date:** {{ ansible_date_time.iso8601 }}
          **Server:** {{ ai_server_info.server_info.server_name }}
          **Protocol:** {{ ai_server_info.server_info.protocol_version }}

          ## Tools Tested

          1. **query_documents**: {{ 'PASS' if query_test.test_passed else 'FAIL' }}
             - Execution Time: {{ query_test.execution_time }}s

          2. **chat_with_context**: {{ 'PASS' if chat_test.test_passed else 'FAIL' }}
             - Execution Time: {{ chat_test.execution_time }}s

          3. **get_project_status**: {{ 'PASS' if status_test.test_passed else 'FAIL' }}
             - Execution Time: {{ status_test.execution_time }}s

          ## Summary

          - Total Tools: 3
          - Passed: {{ [query_test.test_passed, chat_test.test_passed, status_test.test_passed] | select('equalto', true) | list | length }}
          - Failed: {{ [query_test.test_passed, chat_test.test_passed, status_test.test_passed] | select('equalto', false) | list | length }}
        dest: "/opt/qubinode_navigator/tests/mcp/ai_assistant_test_report.md"
      tags: [report]
