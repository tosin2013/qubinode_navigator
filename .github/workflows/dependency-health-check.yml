name: Dependency Health Check

# Weekly dependency validation to catch conflicts early
# Runs every Monday at 8am UTC to check all Python dependencies
# across the project can be installed without conflicts

on:
  schedule:
    # Run every Monday at 8am UTC
    - cron: '0 8 * * 1'
  # Allow manual triggering for testing
  workflow_dispatch:

permissions:
  contents: read
  issues: write  # To create issues if dependencies fail

env:
  PYTHON_VERSION: '3.12'

jobs:
  check-ai-assistant-deps:
    name: Check AI Assistant Dependencies
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Validate AI Assistant dependencies
        id: ai-assistant-check
        continue-on-error: true
        run: |
          cd ai-assistant
          echo "ðŸ“¦ Installing AI Assistant dependencies..."
          pip install -r requirements.txt

          echo ""
          echo "ðŸ” Validating dependency compatibility..."
          if pip check; then
            echo "âœ… AI Assistant dependencies are compatible"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ AI Assistant dependencies have conflicts"
            echo "status=failure" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Verify requirements.in sync
        id: requirements-sync
        continue-on-error: true
        run: |
          cd ai-assistant
          echo "ðŸ” Checking if requirements.txt is in sync with requirements.in..."
          pip install pip-tools

          # Generate a test requirements.txt and compare
          pip-compile requirements.in --output-file=requirements.test.txt --quiet

          if diff -q requirements.txt requirements.test.txt > /dev/null 2>&1; then
            echo "âœ… requirements.txt is in sync with requirements.in"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ requirements.txt may be out of sync with requirements.in"
            echo "Run 'pip-compile requirements.in' to regenerate"
            echo ""
            echo "Differences found:"
            diff requirements.txt requirements.test.txt || true
            echo "status=warning" >> $GITHUB_OUTPUT
          fi

          rm -f requirements.test.txt

  check-root-deps:
    name: Check Root Dependencies
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Validate root dependencies
        id: root-check
        continue-on-error: true
        run: |
          if [ -f requirements.txt ]; then
            echo "ðŸ“¦ Installing root dependencies..."
            pip install -r requirements.txt

            echo ""
            echo "ðŸ” Validating dependency compatibility..."
            if pip check; then
              echo "âœ… Root dependencies are compatible"
              echo "status=success" >> $GITHUB_OUTPUT
            else
              echo "âŒ Root dependencies have conflicts"
              echo "status=failure" >> $GITHUB_OUTPUT
              exit 1
            fi
          else
            echo "â„¹ï¸ No root requirements.txt found, skipping"
            echo "status=skipped" >> $GITHUB_OUTPUT
          fi

  check-ansible-builder-deps:
    name: Check Ansible Builder Dependencies
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Validate ansible-builder dependencies
        id: ansible-builder-check
        continue-on-error: true
        run: |
          if [ -f ansible-builder/requirements.txt ]; then
            echo "ðŸ“¦ Installing ansible-builder dependencies..."
            pip install -r ansible-builder/requirements.txt

            echo ""
            echo "ðŸ” Validating dependency compatibility..."
            if pip check; then
              echo "âœ… Ansible Builder dependencies are compatible"
              echo "status=success" >> $GITHUB_OUTPUT
            else
              echo "âŒ Ansible Builder dependencies have conflicts"
              echo "status=failure" >> $GITHUB_OUTPUT
              exit 1
            fi
          else
            echo "â„¹ï¸ No ansible-builder requirements.txt found, skipping"
            echo "status=skipped" >> $GITHUB_OUTPUT
          fi

  check-bash-aliases-deps:
    name: Check Bash Aliases Dependencies
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Validate bash-aliases dependencies
        id: bash-aliases-check
        continue-on-error: true
        run: |
          if [ -f bash-aliases/requirements.txt ]; then
            echo "ðŸ“¦ Installing bash-aliases dependencies..."
            pip install -r bash-aliases/requirements.txt

            echo ""
            echo "ðŸ” Validating dependency compatibility..."
            if pip check; then
              echo "âœ… Bash Aliases dependencies are compatible"
              echo "status=success" >> $GITHUB_OUTPUT
            else
              echo "âŒ Bash Aliases dependencies have conflicts"
              echo "status=failure" >> $GITHUB_OUTPUT
              exit 1
            fi
          else
            echo "â„¹ï¸ No bash-aliases requirements.txt found, skipping"
            echo "status=skipped" >> $GITHUB_OUTPUT
          fi

  report-results:
    name: Report Health Check Results
    runs-on: ubuntu-latest
    needs: [check-ai-assistant-deps, check-root-deps, check-ansible-builder-deps, check-bash-aliases-deps]
    if: always()

    steps:
      - name: Check job results
        id: check-results
        run: |
          echo "AI Assistant: ${{ needs.check-ai-assistant-deps.result }}"
          echo "Root: ${{ needs.check-root-deps.result }}"
          echo "Ansible Builder: ${{ needs.check-ansible-builder-deps.result }}"
          echo "Bash Aliases: ${{ needs.check-bash-aliases-deps.result }}"

          # Count failures
          failures=0
          if [ "${{ needs.check-ai-assistant-deps.result }}" == "failure" ]; then
            failures=$((failures + 1))
          fi
          if [ "${{ needs.check-root-deps.result }}" == "failure" ]; then
            failures=$((failures + 1))
          fi
          if [ "${{ needs.check-ansible-builder-deps.result }}" == "failure" ]; then
            failures=$((failures + 1))
          fi
          if [ "${{ needs.check-bash-aliases-deps.result }}" == "failure" ]; then
            failures=$((failures + 1))
          fi

          echo "failures=$failures" >> $GITHUB_OUTPUT

          if [ $failures -gt 0 ]; then
            echo "has_failures=true" >> $GITHUB_OUTPUT
          else
            echo "has_failures=false" >> $GITHUB_OUTPUT
          fi

      - name: Create issue on failure
        if: steps.check-results.outputs.has_failures == 'true'
        uses: actions/github-script@v8
        with:
          script: |
            const title = 'ðŸš¨ Weekly Dependency Health Check Failed';
            const body = `## Dependency Health Check Results

            The weekly dependency health check has detected issues with one or more dependency sets.

            ### Results Summary

            - **AI Assistant**: ${{ needs.check-ai-assistant-deps.result }}
            - **Root**: ${{ needs.check-root-deps.result }}
            - **Ansible Builder**: ${{ needs.check-ansible-builder-deps.result }}
            - **Bash Aliases**: ${{ needs.check-bash-aliases-deps.result }}

            ### Action Required

            1. Review the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details
            2. Check for dependency conflicts using \`pip check\`
            3. Update conflicting dependencies in the respective requirements.txt files
            4. For AI Assistant, run \`pip-compile requirements.in\` to regenerate requirements.txt
            5. Test the changes locally before committing

            ### Related Documentation

            - [AI Assistant Dependency Management](./ai-assistant/README-requirements.md)
            - [Dependabot Configuration](./.github/dependabot.yml)

            ---

            **Run ID**: ${{ github.run_id }}
            **Triggered**: ${{ github.event_name }}
            **Branch**: ${{ github.ref }}`;

            // Check if an issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: ['dependencies', 'automated-issue']
            });

            const existingIssue = issues.data.find(issue =>
              issue.title.includes('Weekly Dependency Health Check Failed')
            );

            if (existingIssue) {
              // Update existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `## New Health Check Failure\n\n${body}`
              });
              console.log(`Updated existing issue #${existingIssue.number}`);
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['dependencies', 'automated-issue', 'high-priority']
              });
              console.log('Created new dependency health check issue');
            }

      - name: Create summary
        if: always()
        run: |
          echo "# Dependency Health Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Function to get status icon
          get_icon() {
            case "$1" in
              "success") echo "âœ…" ;;
              "failure") echo "âŒ" ;;
              "skipped") echo "â­ï¸" ;;
              *) echo "â“" ;;
            esac
          }

          echo "- $(get_icon '${{ needs.check-ai-assistant-deps.result }}') **AI Assistant**: ${{ needs.check-ai-assistant-deps.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- $(get_icon '${{ needs.check-root-deps.result }}') **Root**: ${{ needs.check-root-deps.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- $(get_icon '${{ needs.check-ansible-builder-deps.result }}') **Ansible Builder**: ${{ needs.check-ansible-builder-deps.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- $(get_icon '${{ needs.check-bash-aliases-deps.result }}') **Bash Aliases**: ${{ needs.check-bash-aliases-deps.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check-results.outputs.has_failures }}" == "true" ]; then
            echo "## âš ï¸ Action Required" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "One or more dependency sets have conflicts. Please review the job logs above for details." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "1. Check the detailed logs for each failed job" >> $GITHUB_STEP_SUMMARY
            echo "2. Run \`pip check\` locally in the affected directories" >> $GITHUB_STEP_SUMMARY
            echo "3. Update conflicting dependencies" >> $GITHUB_STEP_SUMMARY
            echo "4. For AI Assistant, use \`pip-compile requirements.in\` to regenerate requirements.txt" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âœ… All Checks Passed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All dependency sets are healthy and compatible." >> $GITHUB_STEP_SUMMARY
          fi
