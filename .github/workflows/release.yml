name: Release Pipeline

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers on version tags like v0.1.0, v1.0.0, etc.
  workflow_dispatch:  # Allow manual triggering
    inputs:
      version:
        description: 'Release version (e.g., 0.1.0)'
        required: true
        type: string
      prerelease:
        description: 'Mark as pre-release'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  packages: write
  issues: write
  pull-requests: write

jobs:
  validate:
    name: Validate Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for changelog

      - name: Determine version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ github.event.inputs.version }}"
            TAG="v${VERSION}"
          else
            TAG="${GITHUB_REF#refs/tags/}"
            VERSION="${TAG#v}"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "Release version: ${VERSION}"
          echo "Release tag: ${TAG}"

      - name: Validate version format
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9]+)?$ ]]; then
            echo "Error: Invalid version format: $VERSION"
            echo "Expected format: X.Y.Z or X.Y.Z-suffix"
            exit 1
          fi

      - name: Check if tag exists
        run: |
          TAG="${{ steps.version.outputs.tag }}"
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "Tag $TAG already exists"
            if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
              echo "Error: Cannot create release - tag already exists"
              exit 1
            fi
          else
            echo "Tag $TAG does not exist yet - will be created"
          fi

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov ansible-core
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Run unit tests
        run: |
          if [ -d "tests/unit" ]; then
            python -m pytest tests/unit/ -v --tb=short || echo "Unit tests completed with warnings"
          else
            echo "No unit tests directory found - skipping"
          fi

      - name: Run integration tests
        run: |
          if [ -d "tests/integration" ]; then
            python -m pytest tests/integration/ -v --tb=short || echo "Integration tests completed with warnings"
          else
            echo "No integration tests directory found - skipping"
          fi

  build-containers:
    name: Build Container Images
    runs-on: ubuntu-latest
    needs: [validate, test]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Jekyll documentation container
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.jekyll
          push: true
          tags: |
            ghcr.io/qubinode/qubinode-docs:${{ needs.validate.outputs.version }}
            ghcr.io/qubinode/qubinode-docs:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [validate, test, build-containers]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate changelog
        id: changelog
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          TAG="${{ needs.validate.outputs.tag }}"
          
          # Get previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          if [ -z "$PREV_TAG" ]; then
            echo "## Initial Release" > CHANGELOG.md
            echo "" >> CHANGELOG.md
            echo "First release of Qubinode Navigator ${VERSION}" >> CHANGELOG.md
          else
            echo "## Changes since ${PREV_TAG}" > CHANGELOG.md
            echo "" >> CHANGELOG.md
            
            # Features
            FEATURES=$(git log ${PREV_TAG}..HEAD --pretty=format:"- %s" --grep="^feat" || echo "")
            if [ -n "$FEATURES" ]; then
              echo "### âœ¨ Features" >> CHANGELOG.md
              echo "$FEATURES" >> CHANGELOG.md
              echo "" >> CHANGELOG.md
            fi
            
            # Bug fixes
            FIXES=$(git log ${PREV_TAG}..HEAD --pretty=format:"- %s" --grep="^fix" || echo "")
            if [ -n "$FIXES" ]; then
              echo "### ðŸ› Bug Fixes" >> CHANGELOG.md
              echo "$FIXES" >> CHANGELOG.md
              echo "" >> CHANGELOG.md
            fi
            
            # Documentation
            DOCS=$(git log ${PREV_TAG}..HEAD --pretty=format:"- %s" --grep="^docs" || echo "")
            if [ -n "$DOCS" ]; then
              echo "### ðŸ“š Documentation" >> CHANGELOG.md
              echo "$DOCS" >> CHANGELOG.md
              echo "" >> CHANGELOG.md
            fi
            
            # All commits
            echo "### ðŸ“ All Changes" >> CHANGELOG.md
            git log ${PREV_TAG}..HEAD --pretty=format:"- %s (%h)" >> CHANGELOG.md
          fi
          
          echo "" >> CHANGELOG.md
          echo "---" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "## ðŸš€ Quick Start" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo '```bash' >> CHANGELOG.md
          echo 'git clone https://github.com/Qubinode/qubinode_navigator.git' >> CHANGELOG.md
          echo 'cd qubinode_navigator' >> CHANGELOG.md
          echo "git checkout ${TAG}" >> CHANGELOG.md
          echo './setup_modernized.sh' >> CHANGELOG.md
          echo '```' >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "## ðŸ“š Documentation" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "- [Complete Documentation](https://qubinode.github.io/qubinode_navigator/)" >> CHANGELOG.md
          echo "- [MCP Quick Start](MCP-QUICK-START.md)" >> CHANGELOG.md
          echo "- [Installation Guide](docs/tutorials/getting-started.md)" >> CHANGELOG.md
          
          cat CHANGELOG.md

      - name: Create or update tag
        if: github.event_name == 'workflow_dispatch'
        run: |
          TAG="${{ needs.validate.outputs.tag }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "$TAG" -m "Release $TAG"
          git push origin "$TAG"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.validate.outputs.tag }}
          name: Release ${{ needs.validate.outputs.version }}
          body_path: CHANGELOG.md
          draft: false
          prerelease: ${{ github.event.inputs.prerelease || false }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  post-release:
    name: Post-Release Tasks
    runs-on: ubuntu-latest
    needs: [validate, create-release]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create release announcement issue
        uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ needs.validate.outputs.version }}';
            const tag = '${{ needs.validate.outputs.tag }}';
            
            const body = `## ðŸŽ‰ Release ${version} is now available!
            
            **Release Notes**: https://github.com/${{ github.repository }}/releases/tag/${tag}
            
            ### Quick Start
            \`\`\`bash
            git clone https://github.com/${{ github.repository }}.git
            cd qubinode_navigator
            git checkout ${tag}
            ./setup_modernized.sh
            \`\`\`
            
            ### Documentation
            - [Complete Documentation](https://qubinode.github.io/qubinode_navigator/)
            - [MCP Quick Start](https://github.com/${{ github.repository }}/blob/${tag}/MCP-QUICK-START.md)
            
            This issue is automatically created to track the release.`;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Release ${version} Available`,
              body: body,
              labels: ['release', 'announcement']
            });

      - name: Summary
        run: |
          echo "## âœ… Release ${{ needs.validate.outputs.version }} Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag**: ${{ needs.validate.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Release URL**: https://github.com/${{ github.repository }}/releases/tag/${{ needs.validate.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Container Images**: ghcr.io/qubinode/qubinode-docs:${{ needs.validate.outputs.version }}" >> $GITHUB_STEP_SUMMARY
