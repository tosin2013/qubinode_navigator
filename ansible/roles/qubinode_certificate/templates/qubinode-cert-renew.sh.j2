#!/bin/bash
# Qubinode Certificate Renewal Script
# Auto-generated by Ansible role: qubinode_certificate
# ADR-0054: Unified Certificate Management

set -euo pipefail

CERT_BASE_DIR="{{ cert_base_dir }}"
RENEWAL_DAYS="{{ cert_renewal_days }}"
LOG_FILE="/var/log/qubinode-cert-renew.log"

log() {
    echo "$(date -Iseconds) $1" | tee -a "$LOG_FILE"
}

log "Starting certificate renewal check..."

# Check each certificate directory
for cert_dir in "$CERT_BASE_DIR"/*/; do
    if [[ ! -d "$cert_dir" ]] || [[ "$(basename "$cert_dir")" == "ca" ]]; then
        continue
    fi

    hostname=$(basename "$cert_dir")
    cert_file="$cert_dir/cert.pem"
    metadata_file="$cert_dir/.metadata.json"

    if [[ ! -f "$cert_file" ]]; then
        continue
    fi

    # Get expiry date
    expiry_date=$(openssl x509 -in "$cert_file" -noout -enddate 2>/dev/null | cut -d= -f2)
    if [[ -z "$expiry_date" ]]; then
        log "WARNING: Could not read expiry for $hostname"
        continue
    fi

    expiry_epoch=$(date -d "$expiry_date" +%s 2>/dev/null || echo "0")
    now_epoch=$(date +%s)
    days_left=$(( (expiry_epoch - now_epoch) / 86400 ))

    # Get CA type from metadata
    ca_type="unknown"
    if [[ -f "$metadata_file" ]]; then
        ca_type=$(jq -r '.ca // "unknown"' "$metadata_file" 2>/dev/null || echo "unknown")
    fi

    # Determine renewal threshold based on CA type
    threshold=$RENEWAL_DAYS
    if [[ "$ca_type" == "vault" ]]; then
        threshold=1  # Vault certs are typically short-lived
    fi

    log "Checking $hostname: $days_left days remaining (CA: $ca_type, threshold: $threshold days)"

    if [[ $days_left -lt $threshold ]]; then
        log "RENEWING: $hostname (expires in $days_left days)"

        # Run renewal hook if exists
        renew_hook="$cert_dir/.renew-hook.sh"

        # Use qubinode-cert if available
        if command -v qubinode-cert &>/dev/null; then
            if qubinode-cert renew "$hostname" 2>&1 | tee -a "$LOG_FILE"; then
                log "SUCCESS: Renewed $hostname"

                # Run service reload hook
                if [[ -x "$renew_hook" ]]; then
                    log "Running reload hook for $hostname"
                    "$renew_hook" 2>&1 | tee -a "$LOG_FILE" || true
                fi
            else
                log "ERROR: Failed to renew $hostname"
            fi
        else
            log "WARNING: qubinode-cert not found, skipping renewal for $hostname"
        fi
    fi
done

log "Certificate renewal check complete."
