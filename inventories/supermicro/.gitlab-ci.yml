stages:
  - check_env
  - supermicro

check_env:
  stage: check_env
  image: python:3.10
  script:
    - python3 inventories/supermicro/check_env.py

build:
  stage: supermicro
  image: fedora:37
  variables:
    SSH_USER: admin
    SSH_PASSWORD:  "${SSH_PASSWORD}"
    CICD_PIPELINE: 'true'
    ENV_USERNAME: admin
    DOMAIN: qubinodelab.io
    FORWARDER: '8.8.8.8'
    ACTIVE_BRIDGE: 'true'
    INTERFACE: eno1
    DISK: /dev/nvme0n1
    USE_HASHICORP_VAULT: 'true'
    VAULT_ADDRESS: http://10.0.0.48:8200/
    VAULT_TOKEN: s.KXRhGYyDynew8LjTgbqeIJ1m
    SECRET_PATH:  homelab
    GIT_REPO:  https://gitlab.tosins-cloudlabs.com/tosin/qubinode_navigator.git
    INVENTORY: supermicro
  script:
    - dnf install wget openssh-clients sshpass -y
    - mkdir -p ~/.ssh/
    - ssh-keygen -t rsa -b 4096 -f ~/.ssh/id_rsa -N ""
    - sshpass -p "$SSH_PASSWORD" ssh-copy-id -o StrictHostKeyChecking=no "$SSH_USER"@"$SSH_HOST"
    - sed -i 's|export GIT_REPO=.*|GIT_REPO="'$GIT_REPO'"|g' setup.sh
    - ssh "$SSH_USER"@"$SSH_HOST"  'env CICD_PIPELINE="'$CICD_PIPELINE'" SSH_PASSWORD="'$SSH_PASSWORD'"
        ENV_USERNAME="'$ENV_USERNAME'" DOMAIN="'$DOMAIN'" FORWARDER="'$FORWARDER'" INVENTORY="'$INVENTORY'"
        ACTIVE_BRIDGE="'$ACTIVE_BRIDGE'" INTERFACE="'$INTERFACE'" DISK="'$DISK'" USE_HASHICORP_VAULT="'${USE_HASHICORP_VAULT}'"
        VAULT_ADDRESS="'$VAULT_ADDRESS'" VAULT_TOKEN="'${VAULT_TOKEN}'" SECRET_PATH="'${SECRET_PATH}'" bash -s' < setup.sh
  only:
    - main

